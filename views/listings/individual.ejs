<% layout("/layouts/boilerplate") %>
<!-- eslint-disable -->
    <div class="container">
        <div class="row mt-3">
            <!-- Left-aligned heading in same grid as card -->
            <div class="col-6 offset-3">
                <h2>
                    <%= listing.title %>
                </h2>
            </div>

            <!-- Centered card inside same grid -->
            <div class="card col-6 offset-3 listing-card">
                <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="Listing Image">
                <div class="card-body">
                    <p class="card-text">
                        <% if(listing.owner) { %>
                            <i>Listed by: <%= listing.owner.username %></i>
                            <% } else { %>
                                <i>Listed by: Anonymous</i>
                                <% } %><br>
                                    <%= listing.description %><br>
                                        ₹<%= listing.price.toLocaleString("en-IN") %><br>
                                            <%= listing.location %><br>
                                                <%= listing.country %><br>
                    </p>
                    <div class="small text-muted">Total rooms: <%= listing.totalRooms || 1 %></div>
                    <div id="roomsAvailability" class="small text-muted">
                        <% if (typeof roomsLeftForRange !== 'undefined' && roomsLeftForRange !== null) { %>
                            Available for selected dates: <%= roomsLeftForRange %>
                        <% } %>
                    </div>
                    <% if (breakdown) { %>
                        <div class="mt-2 p-2 border rounded">
                            <div><strong>Price breakdown</strong></div>
                            <div class="d-flex justify-content-between small"><span>₹<%= breakdown.perNight.toLocaleString('en-IN') %> x <%= breakdown.nights %> night(s)</span><span>₹<%= breakdown.subtotal.toLocaleString('en-IN') %></span></div>
                            <div class="d-flex justify-content-between small"><span>Cleaning fee</span><span>₹<%= breakdown.cleaningFee.toLocaleString('en-IN') %></span></div>
                            <div class="d-flex justify-content-between small"><span>Service fee</span><span>₹<%= breakdown.serviceFee.toLocaleString('en-IN') %></span></div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between"><strong>Total</strong><strong>₹<%= breakdown.total.toLocaleString('en-IN') %></strong></div>
                            <% if (typeof roomsLeftForRange !== 'undefined' && roomsLeftForRange !== null) { %>
                                <div class="mt-2 small text-muted">Rooms left for your dates: <%= roomsLeftForRange %></div>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            </div>

            <% if(currentUser && listing.owner && currentUser._id.equals(listing.owner._id)) { %>
                <!-- Buttons aligned to left under the card -->
                <div class="col-6 offset-3 mt-3 d-flex gap-2">
                    <form action="/listings/<%= listing._id %>/edit">
                        <button class="btn btn-dark add-btn">Edit</button>
                    </form>
                    <form method="post" action="/listings/<%= listing._id %>?_method=DELETE">
                        <button class="btn btn-dark add-btn">Delete</button>
                    </form>
                    <form action="/listings">
                        <button class="btn btn-dark">Go Back</button>
                    </form>
                </div>
                <% } %>

                    <% if(currentUser) { %>

                        <div class="col-8 offset-3 mb-3">
                            <hr>
                            <h4>Book this stay</h4>
                            <form method="post" action="/listings/<%= listing._id %>/book" class="row g-2 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Check‑in</label>
                                    <input type="date" class="form-control" name="checkIn" value="<%= (checkIn || '') %>" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Check‑out</label>
                                    <input type="date" class="form-control" name="checkOut" value="<%= (checkOut || '') %>" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Rooms</label>
                                    <input type="number" class="form-control" name="rooms" min="1" value="1" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Guests</label>
                                    <input type="number" class="form-control" name="guests" min="1" value="1" required>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-dark add-btn mt-2">Reserve</button>
                                </div>
                            </form>
                            <h4>Leave a Review</h4>
                            <form method="post" action="/listings/<%= listing._id %>/reviews" novalidate
                                class="needs-validation">
                                <label for="rating" class="form-label">Rating:</label>
                                <fieldset class="starability-slot">
                                    <input type="radio" id="first-rate1" name="review[rating]" value="1" required
                                        checked />
                                    <label for="first-rate1" title="Terrible">1 star</label>
                                    <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                                    <label for="first-rate2" title="Not good">2 stars</label>
                                    <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                                    <label for="first-rate3" title="Average">3 stars</label>
                                    <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                                    <label for="first-rate4" title="Very good">4 stars</label>
                                    <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                                    <label for="first-rate5" title="Amazing">5 stars</label>
                                </fieldset>

                                <div class="mb-3 mt-3">
                                    <label for="comment" class="form-label">Comment</label>
                                    <textarea id="comment" name="review[comment]" class="form-control"
                                        required></textarea>
                                    <div class="invalid-feedback">Please enter a comment.</div>
                                </div>
                                <button class="btn btn-dark mt-2">Submit Review</button>
                            </form>
                            <% } %>
                                <hr>
                                <h4>Reviews</h4>
                                <% if(listing.reviews.length===0){ %>
                                    <p class="text-muted">No reviews yet. Be the first to review!</p>
                                    <% } %>

                                        <div class="row">
                                            <% for(review of listing.reviews){ %>
                                                <div class="card col-5 ms-3 mb-3">
                                                    <div class="card-body">
                                                        <h5 class="card-title">@<%= review.author.username %>
                                                        </h5>
                                                        <p class="starability-result card-text"
                                                            data-rating="<%= review.rating %>"></p>
                                                        <p class="card-text">
                                                            <%= review.comment %>
                                                        </p>

                                                        <form
                                                            action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                                                            method="post" class="mb-3">
                                                            <button class="btn btn-dark">Delete</button>
                                                        </form>
                                                    </div>
                                                </div>
                                                <% } %>
                                        </div>
                        </div>

                        <!-- Map Section -->
                        <div class="col-12 mt-4">
                            <div class="map-container">
                                <div id="map" class="map"></div>
                            </div>
                        </div>
        </div>
    </div>

    <!-- Leaflet CSS (Alternative to MapTiler SDK) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Script (More reliable than MapTiler SDK) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Map initialization script -->
    <script src="/js/map-init.js"></script>
    
    <script>
        // Pass listing data to the map initialization function
        // @ts-nocheck
        // eslint-disable-next-line
        const listingData = <%- JSON.stringify(listing) %>;
        initializeMapWithData(listingData);
    </script>